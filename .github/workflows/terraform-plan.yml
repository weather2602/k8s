name: Terraform Plan

on:
    pull_request:
        branches: ["main"]

permissions:
    contents: read
    id-token: write

jobs:
    terraform:
        name: Terraform Plan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Authenticate to GCP (WIF)
              id: auth
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
                  service_account: ${{ secrets.CICD_SERVICE_ACCOUNT }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.9.8 # or whichever youâ€™re using

            - name: Terraform Init
              run: |
                  terraform init \
                      -backend-config="bucket=${TF_BACKEND_BUCKET}" \
                      -backend-config="prefix=terraform/state"
              env:
                  GOOGLE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
                  TF_BACKEND_BUCKET: ${{ secrets.TF_BACKEND_BUCKET }}

            - name: Terraform Plan
              run: terraform plan -input=false -var="project_id=${GOOGLE_PROJECT}"
              env:
                  GOOGLE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
                  TF_BACKEND_BUCKET: ${{ secrets.TF_BACKEND_BUCKET }}
